"use strict";
//angular imports
var core_1 = require("@angular/core");
var Rx_1 = require("rxjs/Rx");
//3rd party imports
var _ = require("lodash");
//app imports
var _1 = require("./");
var mock_data_service_1 = require("./mock-data.service");
var static_data_1 = require("../shared/static-data");
var BacklogService = (function () {
    function BacklogService(mockDataService, userService, authService, zone) {
        var _this = this;
        this.mockDataService = mockDataService;
        this.userService = userService;
        this.authService = authService;
        this.zone = zone;
        this._genetatedItems = [];
        this._allItems = [];
        this._filteredItems = [];
        this._genetatedItems = this.mockDataService.generatePTItems(this.userService.users);
        this._itemsSubj = new Rx_1.BehaviorSubject([]);
        _.forEach(this._genetatedItems, function (item) {
            _this._allItems.push(item);
        });
        this._filterState = { filterViewIndex: 0 };
        this.publishUpdates();
        this._itemsObs = Rx_1.Observable.create(function (observer) {
            _this._observer = observer;
            observer.next(_this._allItems);
        });
    }
    Object.defineProperty(BacklogService.prototype, "itemsSubj", {
        get: function () {
            return this._itemsSubj;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(BacklogService.prototype, "items", {
        get: function () {
            return this._genetatedItems;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(BacklogService.prototype, "ptItemsObs", {
        get: function () {
            return this._itemsObs;
        },
        enumerable: true,
        configurable: true
    });
    BacklogService.prototype.getItem = function (id) {
        var selectedItem = _.find(this._allItems, function (i) { return i.id == id; });
        return Promise.resolve(selectedItem);
    };
    BacklogService.prototype.addNewPTItem = function (newItem, assignee) {
        var item = {
            id: _.uniqueId(),
            title: newItem.title,
            description: newItem.description,
            type: newItem.type,
            estimate: 0,
            priority: static_data_1.PriorityEnum.Medium,
            status: static_data_1.StatusEnum.Open,
            assignee: assignee,
            tasks: [],
            comments: [],
            dateCreated: new Date(),
            dateModified: new Date()
        };
        this.addItem(item);
    };
    BacklogService.prototype.addItem = function (item) {
        this._allItems.unshift(item);
        this._observer.next(this._allItems);
        this.publishUpdates();
    };
    BacklogService.prototype.deleteItem = function (item) {
        _.remove(this._allItems, function (ptitem) { return ptitem.id === item.id; });
        this.publishUpdates();
    };
    BacklogService.prototype.toggleTask = function (item, task) {
        var index = _.indexOf(item.tasks, task);
        task.completed = !task.completed;
        item.tasks.splice(index, 1, task);
    };
    BacklogService.prototype.updateTask = function (item, task, newTitle) {
        var index = _.indexOf(item.tasks, task);
        task.title = newTitle;
        item.tasks.splice(index, 1, task);
    };
    BacklogService.prototype.addTask = function (item, newTask) {
        var task = {
            id: _.uniqueId(),
            title: newTask.title,
            completed: newTask.completed,
            dateCreated: new Date(),
            dateModified: new Date()
        };
        item.tasks.unshift(task);
    };
    BacklogService.prototype.addComment = function (item, newComment) {
        var comment = {
            id: _.uniqueId(),
            title: newComment.title,
            user: _.find(this.userService.users, function (user) { return user.id === newComment.userId; }),
            dateCreated: new Date(),
            dateModified: new Date()
        };
        item.comments.unshift(comment);
    };
    BacklogService.prototype.updatePtItem = function (item) {
        this.publishUpdates();
    };
    BacklogService.prototype.updatePtItemEstimate = function (item, incdec) {
        if (item.estimate === 0 && !incdec)
            return;
        item.estimate = incdec ? item.estimate + 1 : item.estimate - 1;
        this.publishUpdates();
    };
    BacklogService.prototype.updatePtItemPriority = function (item, incdec) {
        if (static_data_1.PriorityEnum.isMax(item.priority) && incdec)
            return;
        if (static_data_1.PriorityEnum.isMin(item.priority) && !incdec)
            return;
        if (incdec) {
            item.priority = static_data_1.PriorityEnum.nextPriority(item.priority);
        }
        else {
            item.priority = static_data_1.PriorityEnum.previousPriority(item.priority);
        }
        this.publishUpdates();
    };
    BacklogService.prototype.updatePtItemType = function (item, newType) {
        item.type = newType;
        this.publishUpdates();
    };
    BacklogService.prototype.updatePtItemAssignee = function (item, user) {
        item.assignee = user;
        this.publishUpdates();
    };
    BacklogService.prototype.updatePtItemStatus = function (item, newStatusStr) {
        var newStatus = static_data_1.StatusEnum[newStatusStr];
        if (item.status != newStatus) {
            item.status = newStatus;
            this.publishUpdates();
        }
    };
    BacklogService.prototype.switchAssignee = function (item) {
        var ranUser = _.sample(this.userService.users);
        item.assignee = ranUser;
        this.publishUpdates();
    };
    BacklogService.prototype.filter = function (filterState) {
        this._filterState = filterState;
        this.publishUpdates();
    };
    BacklogService.prototype.publishUpdates = function () {
        var _this = this;
        var filteredItems = [];
        switch (this._filterState.filterViewIndex) {
            case 0:
                filteredItems = this._allItems.filter(function (i) { return i.assignee.id === _this.authService.currentUser.id; });
                break;
            case 1:
                filteredItems = this._allItems.filter(function (i) { return i.status === static_data_1.StatusEnum.Open || i.status === static_data_1.StatusEnum.ReOpened; });
                break;
            case 2:
                filteredItems = this._allItems.filter(function (i) { return i.status === static_data_1.StatusEnum.Closed; });
                break;
            default:
                filteredItems = this._allItems;
        }
        // Make sure all updates are published inside NgZone so that change detection is triggered if needed
        this.zone.run(function () {
            // must emit a *new* value (immutability!)
            _this.itemsSubj.next(filteredItems.slice());
        });
    };
    return BacklogService;
}());
BacklogService = __decorate([
    core_1.Injectable(),
    __metadata("design:paramtypes", [mock_data_service_1.MockDataService,
        _1.UserService,
        _1.AuthenticationService,
        core_1.NgZone])
], BacklogService);
exports.BacklogService = BacklogService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFja2xvZy5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYmFja2xvZy5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxpQkFBaUI7QUFDakIsc0NBQW9EO0FBQ3BELDhCQUFnRTtBQUVoRSxtQkFBbUI7QUFDbkIsMEJBQTRCO0FBRTVCLGFBQWE7QUFDYix1QkFBd0Q7QUFDeEQseURBQXNEO0FBR3RELHFEQUErRTtBQVcvRSxJQUFhLGNBQWM7SUFzQnZCLHdCQUFvQixlQUFnQyxFQUN4QyxXQUF3QixFQUN4QixXQUFrQyxFQUNsQyxJQUFZO1FBSHhCLGlCQW9CQztRQXBCbUIsb0JBQWUsR0FBZixlQUFlLENBQWlCO1FBQ3hDLGdCQUFXLEdBQVgsV0FBVyxDQUFhO1FBQ3hCLGdCQUFXLEdBQVgsV0FBVyxDQUF1QjtRQUNsQyxTQUFJLEdBQUosSUFBSSxDQUFRO1FBdkJoQixvQkFBZSxHQUFtQixFQUFFLENBQUM7UUFLckMsY0FBUyxHQUFtQixFQUFFLENBQUM7UUFDL0IsbUJBQWMsR0FBbUIsRUFBRSxDQUFDO1FBa0J4QyxJQUFJLENBQUMsZUFBZSxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUM7UUFFcEYsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLG9CQUFlLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDMUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsZUFBZSxFQUFFLFVBQUMsSUFBSTtZQUNqQyxLQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM5QixDQUFDLENBQUMsQ0FBQztRQUVILElBQUksQ0FBQyxZQUFZLEdBQUcsRUFBRSxlQUFlLEVBQUUsQ0FBQyxFQUFFLENBQUM7UUFFM0MsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO1FBR3RCLElBQUksQ0FBQyxTQUFTLEdBQUcsZUFBVSxDQUFDLE1BQU0sQ0FBQyxVQUFDLFFBQWtDO1lBQ2xFLEtBQUksQ0FBQyxTQUFTLEdBQUcsUUFBUSxDQUFDO1lBQzFCLFFBQVEsQ0FBQyxJQUFJLENBQUMsS0FBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ2xDLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQWhDRCxzQkFBVyxxQ0FBUzthQUFwQjtZQUNJLE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDO1FBQzNCLENBQUM7OztPQUFBO0lBRUQsc0JBQVcsaUNBQUs7YUFBaEI7WUFDSSxNQUFNLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQztRQUNoQyxDQUFDOzs7T0FBQTtJQUVELHNCQUFXLHNDQUFVO2FBQXJCO1lBQ0ksTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUM7UUFDMUIsQ0FBQzs7O09BQUE7SUF5Qk0sZ0NBQU8sR0FBZCxVQUFlLEVBQVU7UUFDckIsSUFBSSxZQUFZLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLFVBQUEsQ0FBQyxJQUFJLE9BQUEsQ0FBQyxDQUFDLEVBQUUsSUFBSSxFQUFFLEVBQVYsQ0FBVSxDQUFDLENBQUM7UUFDM0QsTUFBTSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUM7SUFDekMsQ0FBQztJQUVNLHFDQUFZLEdBQW5CLFVBQW9CLE9BQWlCLEVBQUUsUUFBZTtRQUNsRCxJQUFJLElBQUksR0FBWTtZQUNoQixFQUFFLEVBQUUsQ0FBQyxDQUFDLFFBQVEsRUFBRTtZQUNoQixLQUFLLEVBQUUsT0FBTyxDQUFDLEtBQUs7WUFDcEIsV0FBVyxFQUFFLE9BQU8sQ0FBQyxXQUFXO1lBQ2hDLElBQUksRUFBRSxPQUFPLENBQUMsSUFBSTtZQUNsQixRQUFRLEVBQUUsQ0FBQztZQUNYLFFBQVEsRUFBRSwwQkFBWSxDQUFDLE1BQU07WUFDN0IsTUFBTSxFQUFFLHdCQUFVLENBQUMsSUFBSTtZQUN2QixRQUFRLEVBQUUsUUFBUTtZQUNsQixLQUFLLEVBQUUsRUFBRTtZQUNULFFBQVEsRUFBRSxFQUFFO1lBQ1osV0FBVyxFQUFFLElBQUksSUFBSSxFQUFFO1lBQ3ZCLFlBQVksRUFBRSxJQUFJLElBQUksRUFBRTtTQUMzQixDQUFDO1FBQ0YsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUN2QixDQUFDO0lBRU0sZ0NBQU8sR0FBZCxVQUFlLElBQWE7UUFDeEIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDN0IsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ3BDLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztJQUMxQixDQUFDO0lBRU0sbUNBQVUsR0FBakIsVUFBa0IsSUFBYTtRQUMzQixDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsVUFBQyxNQUFNLElBQUssT0FBQSxNQUFNLENBQUMsRUFBRSxLQUFLLElBQUksQ0FBQyxFQUFFLEVBQXJCLENBQXFCLENBQUMsQ0FBQztRQUM1RCxJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7SUFDMUIsQ0FBQztJQUVNLG1DQUFVLEdBQWpCLFVBQWtCLElBQWEsRUFBRSxJQUFXO1FBQ3hDLElBQUksS0FBSyxHQUFHLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQztRQUN4QyxJQUFJLENBQUMsU0FBUyxHQUFHLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQztRQUNqQyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ3RDLENBQUM7SUFFTSxtQ0FBVSxHQUFqQixVQUFrQixJQUFhLEVBQUUsSUFBVyxFQUFFLFFBQWdCO1FBQzFELElBQUksS0FBSyxHQUFHLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQztRQUN4QyxJQUFJLENBQUMsS0FBSyxHQUFHLFFBQVEsQ0FBQztRQUN0QixJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ3RDLENBQUM7SUFFTSxnQ0FBTyxHQUFkLFVBQWUsSUFBYSxFQUFFLE9BQWlCO1FBQzNDLElBQUksSUFBSSxHQUFVO1lBQ2QsRUFBRSxFQUFFLENBQUMsQ0FBQyxRQUFRLEVBQUU7WUFDaEIsS0FBSyxFQUFFLE9BQU8sQ0FBQyxLQUFLO1lBQ3BCLFNBQVMsRUFBRSxPQUFPLENBQUMsU0FBUztZQUM1QixXQUFXLEVBQUUsSUFBSSxJQUFJLEVBQUU7WUFDdkIsWUFBWSxFQUFFLElBQUksSUFBSSxFQUFFO1NBQzNCLENBQUM7UUFDRixJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUM3QixDQUFDO0lBRU0sbUNBQVUsR0FBakIsVUFBa0IsSUFBYSxFQUFFLFVBQXVCO1FBQ3BELElBQUksT0FBTyxHQUFhO1lBQ3BCLEVBQUUsRUFBRSxDQUFDLENBQUMsUUFBUSxFQUFFO1lBQ2hCLEtBQUssRUFBRSxVQUFVLENBQUMsS0FBSztZQUN2QixJQUFJLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLEtBQUssRUFBRSxVQUFDLElBQUksSUFBSyxPQUFBLElBQUksQ0FBQyxFQUFFLEtBQUssVUFBVSxDQUFDLE1BQU0sRUFBN0IsQ0FBNkIsQ0FBQztZQUM3RSxXQUFXLEVBQUUsSUFBSSxJQUFJLEVBQUU7WUFDdkIsWUFBWSxFQUFFLElBQUksSUFBSSxFQUFFO1NBQzNCLENBQUM7UUFDRixJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUNuQyxDQUFDO0lBRU0scUNBQVksR0FBbkIsVUFBb0IsSUFBYTtRQUM3QixJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7SUFDMUIsQ0FBQztJQUVNLDZDQUFvQixHQUEzQixVQUE0QixJQUFhLEVBQUUsTUFBZTtRQUN0RCxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxLQUFLLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQztZQUFDLE1BQU0sQ0FBQztRQUMzQyxJQUFJLENBQUMsUUFBUSxHQUFHLE1BQU0sR0FBRyxJQUFJLENBQUMsUUFBUSxHQUFHLENBQUMsR0FBRyxJQUFJLENBQUMsUUFBUSxHQUFHLENBQUMsQ0FBQztRQUMvRCxJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7SUFDMUIsQ0FBQztJQUVNLDZDQUFvQixHQUEzQixVQUE0QixJQUFhLEVBQUUsTUFBZTtRQUN0RCxFQUFFLENBQUMsQ0FBQywwQkFBWSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksTUFBTSxDQUFDO1lBQUMsTUFBTSxDQUFDO1FBQ3hELEVBQUUsQ0FBQyxDQUFDLDBCQUFZLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQztZQUFDLE1BQU0sQ0FBQztRQUV6RCxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1lBQ1QsSUFBSSxDQUFDLFFBQVEsR0FBRywwQkFBWSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDN0QsQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ0osSUFBSSxDQUFDLFFBQVEsR0FBRywwQkFBWSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUNqRSxDQUFDO1FBQ0QsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO0lBQzFCLENBQUM7SUFFTSx5Q0FBZ0IsR0FBdkIsVUFBd0IsSUFBYSxFQUFFLE9BQXFCO1FBQ3hELElBQUksQ0FBQyxJQUFJLEdBQUcsT0FBTyxDQUFDO1FBQ3BCLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztJQUMxQixDQUFDO0lBRU0sNkNBQW9CLEdBQTNCLFVBQTRCLElBQWEsRUFBRSxJQUFXO1FBQ2xELElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztJQUMxQixDQUFDO0lBRU0sMkNBQWtCLEdBQXpCLFVBQTBCLElBQWEsRUFBRSxZQUFvQjtRQUN6RCxJQUFJLFNBQVMsR0FBRyx3QkFBVSxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQ3pDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLElBQUksU0FBUyxDQUFDLENBQUMsQ0FBQztZQUMzQixJQUFJLENBQUMsTUFBTSxHQUFHLFNBQVMsQ0FBQztZQUN4QixJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7UUFDMUIsQ0FBQztJQUNMLENBQUM7SUFFTSx1Q0FBYyxHQUFyQixVQUFzQixJQUFhO1FBQy9CLElBQUksT0FBTyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQVEsSUFBSSxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUN0RCxJQUFJLENBQUMsUUFBUSxHQUFHLE9BQU8sQ0FBQztRQUN4QixJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7SUFDMUIsQ0FBQztJQUVNLCtCQUFNLEdBQWIsVUFBYyxXQUF3QjtRQUNsQyxJQUFJLENBQUMsWUFBWSxHQUFHLFdBQVcsQ0FBQztRQUNoQyxJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7SUFDMUIsQ0FBQztJQUVPLHVDQUFjLEdBQXRCO1FBQUEsaUJBcUJDO1FBcEJHLElBQUksYUFBYSxHQUFHLEVBQUUsQ0FBQztRQUN2QixNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUM7WUFDeEMsS0FBSyxDQUFDO2dCQUNGLGFBQWEsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxVQUFBLENBQUMsSUFBSSxPQUFBLENBQUMsQ0FBQyxRQUFRLENBQUMsRUFBRSxLQUFLLEtBQUksQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDLEVBQUUsRUFBakQsQ0FBaUQsQ0FBQyxDQUFDO2dCQUM5RixLQUFLLENBQUM7WUFDVixLQUFLLENBQUM7Z0JBQ0YsYUFBYSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLFVBQUEsQ0FBQyxJQUFJLE9BQUEsQ0FBQyxDQUFDLE1BQU0sS0FBSyx3QkFBVSxDQUFDLElBQUksSUFBSSxDQUFDLENBQUMsTUFBTSxLQUFLLHdCQUFVLENBQUMsUUFBUSxFQUFoRSxDQUFnRSxDQUFDLENBQUM7Z0JBQzdHLEtBQUssQ0FBQztZQUNWLEtBQUssQ0FBQztnQkFDRixhQUFhLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxDQUFDLENBQUMsTUFBTSxLQUFLLHdCQUFVLENBQUMsTUFBTSxFQUE5QixDQUE4QixDQUFDLENBQUM7Z0JBQzNFLEtBQUssQ0FBQztZQUNWO2dCQUNJLGFBQWEsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDO1FBQ3ZDLENBQUM7UUFFRCxvR0FBb0c7UUFDcEcsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUM7WUFDViwwQ0FBMEM7WUFDMUMsS0FBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUssYUFBYSxTQUFFLENBQUM7UUFDNUMsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBQ0wscUJBQUM7QUFBRCxDQUFDLEFBMUxELElBMExDO0FBMUxZLGNBQWM7SUFEMUIsaUJBQVUsRUFBRTtxQ0F1QjRCLG1DQUFlO1FBQzNCLGNBQVc7UUFDWCx3QkFBcUI7UUFDNUIsYUFBTTtHQXpCZixjQUFjLENBMEwxQjtBQTFMWSx3Q0FBYyIsInNvdXJjZXNDb250ZW50IjpbIi8vYW5ndWxhciBpbXBvcnRzXG5pbXBvcnQgeyBJbmplY3RhYmxlLCAgTmdab25lIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBPYnNlcnZlciwgQmVoYXZpb3JTdWJqZWN0IH0gZnJvbSBcInJ4anMvUnhcIjtcblxuLy8zcmQgcGFydHkgaW1wb3J0c1xuaW1wb3J0ICogYXMgXyBmcm9tICdsb2Rhc2gnO1xuXG4vL2FwcCBpbXBvcnRzXG5pbXBvcnQgeyBBdXRoZW50aWNhdGlvblNlcnZpY2UsIFVzZXJTZXJ2aWNlIH0gZnJvbSAnLi8nO1xuaW1wb3J0IHsgTW9ja0RhdGFTZXJ2aWNlIH0gZnJvbSAnLi9tb2NrLWRhdGEuc2VydmljZSc7XG5pbXBvcnQgeyBGaWx0ZXJTdGF0ZSB9IGZyb20gJy4uL3NoYXJlZC9maWx0ZXItc3RhdGUubW9kZWwnO1xuaW1wb3J0IHsgUFREb21haW4gfSBmcm9tICcuLi90eXBpbmdzL2RvbWFpbic7XG5pbXBvcnQgeyBJdGVtVHlwZUVudW0sIFByaW9yaXR5RW51bSwgU3RhdHVzRW51bSB9IGZyb20gJy4uL3NoYXJlZC9zdGF0aWMtZGF0YSc7XG5pbXBvcnQgSVVzZXIgPSBQVERvbWFpbi5JVXNlcjtcbmltcG9ydCBJUFRJdGVtID0gUFREb21haW4uSVBUSXRlbTtcbmltcG9ydCBJVGFzayA9IFBURG9tYWluLklUYXNrO1xuaW1wb3J0IElDb21tZW50ID0gUFREb21haW4uSUNvbW1lbnQ7XG5pbXBvcnQgSU5ld0l0ZW0gPSBQVERvbWFpbi5JTmV3SXRlbTtcbmltcG9ydCBJTmV3VGFzayA9IFBURG9tYWluLklOZXdUYXNrO1xuaW1wb3J0IElOZXdDb21tZW50ID0gUFREb21haW4uSU5ld0NvbW1lbnQ7XG5cblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEJhY2tsb2dTZXJ2aWNlIHtcblxuICAgIHByaXZhdGUgX2dlbmV0YXRlZEl0ZW1zOiBBcnJheTxJUFRJdGVtPiA9IFtdO1xuICAgIHByaXZhdGUgX2l0ZW1zT2JzOiBPYnNlcnZhYmxlPEFycmF5PElQVEl0ZW0+PjtcbiAgICBwcml2YXRlIF9pdGVtc1N1Ymo6IEJlaGF2aW9yU3ViamVjdDxBcnJheTxJUFRJdGVtPj47XG4gICAgcHJpdmF0ZSBfb2JzZXJ2ZXI6IE9ic2VydmVyPEFycmF5PElQVEl0ZW0+PjtcbiAgICBwcml2YXRlIF9maWx0ZXJTdGF0ZTogRmlsdGVyU3RhdGU7XG4gICAgcHJpdmF0ZSBfYWxsSXRlbXM6IEFycmF5PElQVEl0ZW0+ID0gW107XG4gICAgcHJpdmF0ZSBfZmlsdGVyZWRJdGVtczogQXJyYXk8SVBUSXRlbT4gPSBbXTtcblxuICAgIHB1YmxpYyBnZXQgaXRlbXNTdWJqKCk6IEJlaGF2aW9yU3ViamVjdDxBcnJheTxJUFRJdGVtPj4ge1xuICAgICAgICByZXR1cm4gdGhpcy5faXRlbXNTdWJqO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgaXRlbXMoKTogQXJyYXk8SVBUSXRlbT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5fZ2VuZXRhdGVkSXRlbXM7XG4gICAgfVxuXG4gICAgcHVibGljIGdldCBwdEl0ZW1zT2JzKCk6IE9ic2VydmFibGU8QXJyYXk8SVBUSXRlbT4+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2l0ZW1zT2JzO1xuICAgIH1cblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgbW9ja0RhdGFTZXJ2aWNlOiBNb2NrRGF0YVNlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgdXNlclNlcnZpY2U6IFVzZXJTZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIGF1dGhTZXJ2aWNlOiBBdXRoZW50aWNhdGlvblNlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgem9uZTogTmdab25lKSB7XG4gICAgICAgIHRoaXMuX2dlbmV0YXRlZEl0ZW1zID0gdGhpcy5tb2NrRGF0YVNlcnZpY2UuZ2VuZXJhdGVQVEl0ZW1zKHRoaXMudXNlclNlcnZpY2UudXNlcnMpO1xuXG4gICAgICAgIHRoaXMuX2l0ZW1zU3ViaiA9IG5ldyBCZWhhdmlvclN1YmplY3QoW10pO1xuICAgICAgICBfLmZvckVhY2godGhpcy5fZ2VuZXRhdGVkSXRlbXMsIChpdGVtKSA9PiB7XG4gICAgICAgICAgICB0aGlzLl9hbGxJdGVtcy5wdXNoKGl0ZW0pO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLl9maWx0ZXJTdGF0ZSA9IHsgZmlsdGVyVmlld0luZGV4OiAwIH07XG5cbiAgICAgICAgdGhpcy5wdWJsaXNoVXBkYXRlcygpO1xuXG5cbiAgICAgICAgdGhpcy5faXRlbXNPYnMgPSBPYnNlcnZhYmxlLmNyZWF0ZSgob2JzZXJ2ZXI6IE9ic2VydmVyPEFycmF5PElQVEl0ZW0+PikgPT4ge1xuICAgICAgICAgICAgdGhpcy5fb2JzZXJ2ZXIgPSBvYnNlcnZlcjtcbiAgICAgICAgICAgIG9ic2VydmVyLm5leHQodGhpcy5fYWxsSXRlbXMpO1xuICAgICAgICB9KTtcbiAgICB9XG5cblxuICAgIHB1YmxpYyBnZXRJdGVtKGlkOiBzdHJpbmcpIHtcbiAgICAgICAgbGV0IHNlbGVjdGVkSXRlbSA9IF8uZmluZCh0aGlzLl9hbGxJdGVtcywgaSA9PiBpLmlkID09IGlkKTtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShzZWxlY3RlZEl0ZW0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBhZGROZXdQVEl0ZW0obmV3SXRlbTogSU5ld0l0ZW0sIGFzc2lnbmVlOiBJVXNlcikge1xuICAgICAgICBsZXQgaXRlbTogSVBUSXRlbSA9IHtcbiAgICAgICAgICAgIGlkOiBfLnVuaXF1ZUlkKCksXG4gICAgICAgICAgICB0aXRsZTogbmV3SXRlbS50aXRsZSxcbiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiBuZXdJdGVtLmRlc2NyaXB0aW9uLFxuICAgICAgICAgICAgdHlwZTogbmV3SXRlbS50eXBlLFxuICAgICAgICAgICAgZXN0aW1hdGU6IDAsXG4gICAgICAgICAgICBwcmlvcml0eTogUHJpb3JpdHlFbnVtLk1lZGl1bSxcbiAgICAgICAgICAgIHN0YXR1czogU3RhdHVzRW51bS5PcGVuLFxuICAgICAgICAgICAgYXNzaWduZWU6IGFzc2lnbmVlLFxuICAgICAgICAgICAgdGFza3M6IFtdLFxuICAgICAgICAgICAgY29tbWVudHM6IFtdLFxuICAgICAgICAgICAgZGF0ZUNyZWF0ZWQ6IG5ldyBEYXRlKCksXG4gICAgICAgICAgICBkYXRlTW9kaWZpZWQ6IG5ldyBEYXRlKClcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5hZGRJdGVtKGl0ZW0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBhZGRJdGVtKGl0ZW06IElQVEl0ZW0pIHtcbiAgICAgICAgdGhpcy5fYWxsSXRlbXMudW5zaGlmdChpdGVtKTtcbiAgICAgICAgdGhpcy5fb2JzZXJ2ZXIubmV4dCh0aGlzLl9hbGxJdGVtcyk7XG4gICAgICAgIHRoaXMucHVibGlzaFVwZGF0ZXMoKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZGVsZXRlSXRlbShpdGVtOiBJUFRJdGVtKSB7XG4gICAgICAgIF8ucmVtb3ZlKHRoaXMuX2FsbEl0ZW1zLCAocHRpdGVtKSA9PiBwdGl0ZW0uaWQgPT09IGl0ZW0uaWQpO1xuICAgICAgICB0aGlzLnB1Ymxpc2hVcGRhdGVzKCk7XG4gICAgfVxuXG4gICAgcHVibGljIHRvZ2dsZVRhc2soaXRlbTogSVBUSXRlbSwgdGFzazogSVRhc2spIHtcbiAgICAgICAgdmFyIGluZGV4ID0gXy5pbmRleE9mKGl0ZW0udGFza3MsIHRhc2spO1xuICAgICAgICB0YXNrLmNvbXBsZXRlZCA9ICF0YXNrLmNvbXBsZXRlZDtcbiAgICAgICAgaXRlbS50YXNrcy5zcGxpY2UoaW5kZXgsIDEsIHRhc2spO1xuICAgIH1cblxuICAgIHB1YmxpYyB1cGRhdGVUYXNrKGl0ZW06IElQVEl0ZW0sIHRhc2s6IElUYXNrLCBuZXdUaXRsZTogc3RyaW5nKSB7XG4gICAgICAgIHZhciBpbmRleCA9IF8uaW5kZXhPZihpdGVtLnRhc2tzLCB0YXNrKTtcbiAgICAgICAgdGFzay50aXRsZSA9IG5ld1RpdGxlO1xuICAgICAgICBpdGVtLnRhc2tzLnNwbGljZShpbmRleCwgMSwgdGFzayk7XG4gICAgfVxuXG4gICAgcHVibGljIGFkZFRhc2soaXRlbTogSVBUSXRlbSwgbmV3VGFzazogSU5ld1Rhc2spIHtcbiAgICAgICAgdmFyIHRhc2s6IElUYXNrID0ge1xuICAgICAgICAgICAgaWQ6IF8udW5pcXVlSWQoKSxcbiAgICAgICAgICAgIHRpdGxlOiBuZXdUYXNrLnRpdGxlLFxuICAgICAgICAgICAgY29tcGxldGVkOiBuZXdUYXNrLmNvbXBsZXRlZCxcbiAgICAgICAgICAgIGRhdGVDcmVhdGVkOiBuZXcgRGF0ZSgpLFxuICAgICAgICAgICAgZGF0ZU1vZGlmaWVkOiBuZXcgRGF0ZSgpXG4gICAgICAgIH07XG4gICAgICAgIGl0ZW0udGFza3MudW5zaGlmdCh0YXNrKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYWRkQ29tbWVudChpdGVtOiBJUFRJdGVtLCBuZXdDb21tZW50OiBJTmV3Q29tbWVudCkge1xuICAgICAgICB2YXIgY29tbWVudDogSUNvbW1lbnQgPSB7XG4gICAgICAgICAgICBpZDogXy51bmlxdWVJZCgpLFxuICAgICAgICAgICAgdGl0bGU6IG5ld0NvbW1lbnQudGl0bGUsXG4gICAgICAgICAgICB1c2VyOiBfLmZpbmQodGhpcy51c2VyU2VydmljZS51c2VycywgKHVzZXIpID0+IHVzZXIuaWQgPT09IG5ld0NvbW1lbnQudXNlcklkKSxcbiAgICAgICAgICAgIGRhdGVDcmVhdGVkOiBuZXcgRGF0ZSgpLFxuICAgICAgICAgICAgZGF0ZU1vZGlmaWVkOiBuZXcgRGF0ZSgpXG4gICAgICAgIH07XG4gICAgICAgIGl0ZW0uY29tbWVudHMudW5zaGlmdChjb21tZW50KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgdXBkYXRlUHRJdGVtKGl0ZW06IElQVEl0ZW0pIHtcbiAgICAgICAgdGhpcy5wdWJsaXNoVXBkYXRlcygpO1xuICAgIH1cblxuICAgIHB1YmxpYyB1cGRhdGVQdEl0ZW1Fc3RpbWF0ZShpdGVtOiBJUFRJdGVtLCBpbmNkZWM6IGJvb2xlYW4pIHtcbiAgICAgICAgaWYgKGl0ZW0uZXN0aW1hdGUgPT09IDAgJiYgIWluY2RlYykgcmV0dXJuO1xuICAgICAgICBpdGVtLmVzdGltYXRlID0gaW5jZGVjID8gaXRlbS5lc3RpbWF0ZSArIDEgOiBpdGVtLmVzdGltYXRlIC0gMTtcbiAgICAgICAgdGhpcy5wdWJsaXNoVXBkYXRlcygpO1xuICAgIH1cblxuICAgIHB1YmxpYyB1cGRhdGVQdEl0ZW1Qcmlvcml0eShpdGVtOiBJUFRJdGVtLCBpbmNkZWM6IGJvb2xlYW4pIHtcbiAgICAgICAgaWYgKFByaW9yaXR5RW51bS5pc01heChpdGVtLnByaW9yaXR5KSAmJiBpbmNkZWMpIHJldHVybjtcbiAgICAgICAgaWYgKFByaW9yaXR5RW51bS5pc01pbihpdGVtLnByaW9yaXR5KSAmJiAhaW5jZGVjKSByZXR1cm47XG5cbiAgICAgICAgaWYgKGluY2RlYykge1xuICAgICAgICAgICAgaXRlbS5wcmlvcml0eSA9IFByaW9yaXR5RW51bS5uZXh0UHJpb3JpdHkoaXRlbS5wcmlvcml0eSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpdGVtLnByaW9yaXR5ID0gUHJpb3JpdHlFbnVtLnByZXZpb3VzUHJpb3JpdHkoaXRlbS5wcmlvcml0eSk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5wdWJsaXNoVXBkYXRlcygpO1xuICAgIH1cblxuICAgIHB1YmxpYyB1cGRhdGVQdEl0ZW1UeXBlKGl0ZW06IElQVEl0ZW0sIG5ld1R5cGU6IEl0ZW1UeXBlRW51bSkge1xuICAgICAgICBpdGVtLnR5cGUgPSBuZXdUeXBlO1xuICAgICAgICB0aGlzLnB1Ymxpc2hVcGRhdGVzKCk7XG4gICAgfVxuXG4gICAgcHVibGljIHVwZGF0ZVB0SXRlbUFzc2lnbmVlKGl0ZW06IElQVEl0ZW0sIHVzZXI6IElVc2VyKSB7XG4gICAgICAgIGl0ZW0uYXNzaWduZWUgPSB1c2VyO1xuICAgICAgICB0aGlzLnB1Ymxpc2hVcGRhdGVzKCk7XG4gICAgfVxuXG4gICAgcHVibGljIHVwZGF0ZVB0SXRlbVN0YXR1cyhpdGVtOiBJUFRJdGVtLCBuZXdTdGF0dXNTdHI6IHN0cmluZykge1xuICAgICAgICBsZXQgbmV3U3RhdHVzID0gU3RhdHVzRW51bVtuZXdTdGF0dXNTdHJdO1xuICAgICAgICBpZiAoaXRlbS5zdGF0dXMgIT0gbmV3U3RhdHVzKSB7XG4gICAgICAgICAgICBpdGVtLnN0YXR1cyA9IG5ld1N0YXR1cztcbiAgICAgICAgICAgIHRoaXMucHVibGlzaFVwZGF0ZXMoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBzd2l0Y2hBc3NpZ25lZShpdGVtOiBJUFRJdGVtKSB7XG4gICAgICAgIGxldCByYW5Vc2VyID0gXy5zYW1wbGU8SVVzZXI+KHRoaXMudXNlclNlcnZpY2UudXNlcnMpO1xuICAgICAgICBpdGVtLmFzc2lnbmVlID0gcmFuVXNlcjtcbiAgICAgICAgdGhpcy5wdWJsaXNoVXBkYXRlcygpO1xuICAgIH1cblxuICAgIHB1YmxpYyBmaWx0ZXIoZmlsdGVyU3RhdGU6IEZpbHRlclN0YXRlKSB7XG4gICAgICAgIHRoaXMuX2ZpbHRlclN0YXRlID0gZmlsdGVyU3RhdGU7XG4gICAgICAgIHRoaXMucHVibGlzaFVwZGF0ZXMoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHB1Ymxpc2hVcGRhdGVzKCkge1xuICAgICAgICB2YXIgZmlsdGVyZWRJdGVtcyA9IFtdO1xuICAgICAgICBzd2l0Y2ggKHRoaXMuX2ZpbHRlclN0YXRlLmZpbHRlclZpZXdJbmRleCkge1xuICAgICAgICAgICAgY2FzZSAwOlxuICAgICAgICAgICAgICAgIGZpbHRlcmVkSXRlbXMgPSB0aGlzLl9hbGxJdGVtcy5maWx0ZXIoaSA9PiBpLmFzc2lnbmVlLmlkID09PSB0aGlzLmF1dGhTZXJ2aWNlLmN1cnJlbnRVc2VyLmlkKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgMTpcbiAgICAgICAgICAgICAgICBmaWx0ZXJlZEl0ZW1zID0gdGhpcy5fYWxsSXRlbXMuZmlsdGVyKGkgPT4gaS5zdGF0dXMgPT09IFN0YXR1c0VudW0uT3BlbiB8fCBpLnN0YXR1cyA9PT0gU3RhdHVzRW51bS5SZU9wZW5lZCk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIDI6XG4gICAgICAgICAgICAgICAgZmlsdGVyZWRJdGVtcyA9IHRoaXMuX2FsbEl0ZW1zLmZpbHRlcihpID0+IGkuc3RhdHVzID09PSBTdGF0dXNFbnVtLkNsb3NlZCk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgIGZpbHRlcmVkSXRlbXMgPSB0aGlzLl9hbGxJdGVtcztcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIE1ha2Ugc3VyZSBhbGwgdXBkYXRlcyBhcmUgcHVibGlzaGVkIGluc2lkZSBOZ1pvbmUgc28gdGhhdCBjaGFuZ2UgZGV0ZWN0aW9uIGlzIHRyaWdnZXJlZCBpZiBuZWVkZWRcbiAgICAgICAgdGhpcy56b25lLnJ1bigoKSA9PiB7XG4gICAgICAgICAgICAvLyBtdXN0IGVtaXQgYSAqbmV3KiB2YWx1ZSAoaW1tdXRhYmlsaXR5ISlcbiAgICAgICAgICAgIHRoaXMuaXRlbXNTdWJqLm5leHQoWy4uLmZpbHRlcmVkSXRlbXNdKTtcbiAgICAgICAgfSk7XG4gICAgfVxufSJdfQ==